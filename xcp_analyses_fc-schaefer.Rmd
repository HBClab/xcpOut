---

title: "R Notebook understand and check xcp fcon output for schaefer parcellation
output: html_notebook

---


```{r}
# clear variables
rm(list=ls(all=TRUE))
```


```{r warning=FALSE}
library(plyr)
library(tidyr)
library(dplyr)
library(purrr)
```


```{r}
schaefer_lut <- read.table("./xcp_output-fcon/Schaefer2018_400Parcels_17Networks_order.txt",header=FALSE)
schaefer_lut <- schaefer_lut[,1:2]
names(schaefer_lut) <- c("roi_index","roi_label")
schaefer_lut$roi_label = gsub(pattern = "17Networks_", replacement = "", x = schaefer_lut$roi_label)  
```


Functional connectivity files of interest
* prefix_{atlas_name}_network.txt # correlation matrix in vector form
* prefix_{atlas_name}.net # Pajek adjacency matrix
* prefix_{atlas_name}_ts.1D # Nodal time series
* prefix_{atlas_name}.nii.gz # atlas in input BOLD signal space


```{r}
subs <- read.table("fcon_sublist.txt",header=FALSE)
names(subs) <- c("subject_id")
```


Load to have a look:
```{r}

files <- dir(pattern="sub-.*\\_schaefer400\\.net", all.files = T, recursive=T)

fcon_df <- data.frame()
# sublist <- c("sub-BIKE202","sub-BIKE206")

for (i in subs$subject_id){
     print(i)
        subject_id <- i
        match <- grepl(x=files, pattern=i)
        whichfile <- files[match]
        sub_correlation_matrix_net <- read.table(whichfile,header=FALSE,sep=" ",skip=2)
        sub_correlation_matrix_net <- sub_correlation_matrix_net[,1:3] 
        names(sub_correlation_matrix_net) <- c("roi1","roi2","fc") # give headers
        sub_correlation_matrix_net$subject_id <- i
        fcon_df <<- rbind(fcon_df,sub_correlation_matrix_net)
}

```



look-up table example
http://best-answer.net/easy-way-to-perform-a-lookup-in-r/

```{r}
sub_correlation_matrix_net$roi1_name <- schaefer_lut[match(sub_correlation_matrix_net$roi1,schaefer_lut$roi_index),"roi_label"]
sub_correlation_matrix_net$roi2_name <- schaefer_lut[match(sub_correlation_matrix_net$roi2,schaefer_lut$roi_index),"roi_label"]
```



great start!
-consider separating roi labels by informative pieces for grouping
-use dplyr to group_by and summarize
-consider how to run across subjects

```{r}
sub_correlation_matrix_net <- sub_correlation_matrix_net %>%
separate(col= roi1_name, sep="_", into = c("roi1_hemi", "roi1_subnetwork", "roi1_region", "roi1_regionindex"))

sub_correlation_matrix_net <- sub_correlation_matrix_net %>%
separate(col= roi2_name, sep="_", into = c("roi2_hemi", "roi2_subnetwork", "roi2_region", "roi2_regionindex"))
```


```{r}

sub_correlation_matrix_net$roi1_regionindex <- ifelse(is.na(sub_correlation_matrix_net$roi1_regionindex),sub_correlation_matrix_net$roi1_region,sub_correlation_matrix_net$roi1_regionindex)

sub_correlation_matrix_net$roi1_region <- ifelse(sub_correlation_matrix_net$roi1_region==sub_correlation_matrix_net$roi1_regionindex," ",sub_correlation_matrix_net$roi1_region)

sub_correlation_matrix_net$roi2_regionindex <- ifelse(is.na(sub_correlation_matrix_net$roi2_regionindex),sub_correlation_matrix_net$roi2_region,sub_correlation_matrix_net$roi2_regionindex)

sub_correlation_matrix_net$roi2_region <- ifelse(sub_correlation_matrix_net$roi2_region==sub_correlation_matrix_net$roi2_regionindex," ",sub_correlation_matrix_net$roi2_region)

```


give within and between label for each roi pair
```{r}
sub_correlation_matrix_net$net_relation <- ifelse(sub_correlation_matrix_net$roi1_subnetwork==sub_correlation_matrix_net$roi2_subnetwork,"within","between")
```


averages for within, group_by subnetwork
```{r}
subnet_avgs <- sub_correlation_matrix_net %>%
        select(roi1_subnetwork,roi1_hemi,roi2_subnetwork,roi2_hemi,fc,net_relation) %>%
        filter(net_relation=="within") %>%
        group_by(roi1_subnetwork) %>%
        summarize(avgfc = mean(fc))
  
subnet_avgs      

```

